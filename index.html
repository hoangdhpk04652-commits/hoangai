<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuyên Gia Công Nghệ AI: Đặng Huy Hoàng</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cấu hình Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Nền tối */
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <!-- Phần Giới Thiệu Cá Nhân -->
        <header class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl mb-8 text-white">
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6">
                <!-- Ảnh Profile (Placeholder Logo) -->
                <div class="flex-shrink-0 w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center text-4xl font-bold border-4 border-blue-400">
                    AI
                </div>
                <div>
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-400">Đặng Huy Hoàng</h1>
                    <p class="text-xl mt-1 text-gray-300">Chuyên Gia Tạo Website Công Nghệ AI</p>
                    <div class="mt-3 text-sm space-y-1 text-gray-400">
                        <p><strong>Mã số sinh viên:</strong> PK04652</p>
                        <p><strong>Trường:</strong> FPT Polytechnic</p>
                        <p><strong>Thành phố:</strong> Buôn Mê Thuật</p>
                    </div>
                </div>
            </div>
            <p class="mt-6 text-gray-300 italic">"Ứng dụng trí tuệ nhân tạo để kiến tạo các giải pháp web thông minh và hiệu quả."</p>
        </header>

        <!-- Phần Tra Cứu Thông Tin Web Bằng AI -->
        <main class="bg-gray-900 p-6 sm:p-8 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-blue-400">Tra Cứu Thông Tin Web Bằng AI</h2>
            <p class="text-gray-400 mb-6">Sử dụng mô hình ngôn ngữ Gemini được tăng cường bởi Google Search để truy vấn thông tin mới nhất trên web.</p>

            <div class="space-y-4">
                <textarea id="queryInput" rows="3" class="w-full p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 placeholder-gray-400" placeholder="Nhập câu hỏi của bạn về bất kỳ chủ đề nào... (Ví dụ: Công nghệ AI mới nhất là gì?)"></textarea>
                
                <button id="searchButton" onclick="performSearchWithAI()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50">
                    <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Tra Cứu bằng AI
                </button>
            </div>

            <!-- Kết Quả Tra Cứu -->
            <div id="resultContainer" class="mt-8 p-4 bg-gray-800 border border-gray-700 rounded-lg shadow-inner hidden">
                <h3 class="text-xl font-semibold mb-3 text-green-400">Kết Quả AI</h3>
                <div id="aiResponse" class="text-gray-200 scroll-container whitespace-pre-wrap"></div>
                
                <div id="sourcesContainer" class="mt-4 pt-4 border-t border-gray-700">
                    <h4 class="text-sm font-semibold text-gray-400 mb-2">Nguồn Tham Chiếu (Grounding):</h4>
                    <ul id="sourcesList" class="text-xs text-gray-500 list-disc pl-5 space-y-1"></ul>
                </div>
            </div>

            <!-- Thông báo lỗi -->
            <div id="errorBox" class="mt-4 p-3 bg-red-800 text-white rounded-lg hidden"></div>
        </main>
    </div>

    <!-- Script Firebase và Gemini API -->
    <script type="module">
        // Import các hàm cần thiết từ Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Cấu hình Firebase (Lấy từ biến toàn cục của môi trường)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Khởi tạo Firebase
        let app, db, auth;
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Bật log cho Firestore

                // Đăng nhập người dùng (Sử dụng token nếu có, nếu không thì ẩn danh)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                // console.log("Firebase initialized and user signed in.");
            } else {
                console.warn("Firebase config is missing. Firestore/Auth will not be available.");
            }
        } catch (error) {
            console.error("Firebase initialization or sign-in failed:", error);
            document.getElementById('errorBox').textContent = `Lỗi khởi tạo Firebase: ${error.message}`;
            document.getElementById('errorBox').classList.remove('hidden');
        }

        // --- Logic Tra Cứu AI ---
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent`;
        const API_KEY = ""; // Sẽ được cung cấp tự động bởi Canvas runtime

        const queryInput = document.getElementById('queryInput');
        const searchButton = document.getElementById('searchButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultContainer = document.getElementById('resultContainer');
        const aiResponseDiv = document.getElementById('aiResponse');
        const sourcesList = document.getElementById('sourcesList');
        const errorBox = document.getElementById('errorBox');
        
        let isProcessing = false;

        // Hàm delay cho exponential backoff
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Hàm gọi API với exponential backoff
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 || response.status >= 500) {
                        // Lỗi rate limiting hoặc server error, thử lại
                        const backoffTime = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await delay(backoffTime);
                        continue;
                    }
                    // Lỗi khác (ví dụ: 400 Bad Request, 403 Forbidden)
                    throw new Error(`API returned status ${response.status}: ${await response.text()}`);
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    const backoffTime = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await delay(backoffTime);
                }
            }
        }

        window.performSearchWithAI = async function() {
            if (isProcessing) return;

            const userQuery = queryInput.value.trim();
            if (!userQuery) {
                errorBox.textContent = "Vui lòng nhập câu hỏi để tra cứu.";
                errorBox.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                return;
            }

            // Reset UI
            errorBox.classList.add('hidden');
            resultContainer.classList.add('hidden');
            aiResponseDiv.textContent = '';
            sourcesList.innerHTML = '';

            // Bật trạng thái loading
            isProcessing = true;
            searchButton.disabled = true;
            loadingSpinner.classList.remove('hidden');

            const systemPrompt = "Bạn là một trợ lý tra cứu web chuyên nghiệp. Hãy trả lời câu hỏi của người dùng một cách chính xác, dựa trên thông tin tìm kiếm trên Google. Luôn trả lời bằng Tiếng Việt và giữ tông giọng lịch sự, chuyên nghiệp.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Bật Google Search grounding để tra cứu thông tin trên web
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithBackoff(`${API_URL}?key=${API_KEY}`, options);
                const result = await response.json();

                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    // 1. Trích xuất và hiển thị văn bản trả lời
                    aiResponseDiv.textContent = text;

                    // 2. Trích xuất và hiển thị nguồn tham chiếu (nếu có)
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);

                        sources.forEach(source => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 transition duration-150 truncate block">${source.title}</a>`;
                            sourcesList.appendChild(li);
                        });
                    }

                    // Hiển thị container kết quả
                    resultContainer.classList.remove('hidden');

                } else if (result.error) {
                    throw new Error(result.error.message || "Lỗi API không xác định.");
                } else {
                    aiResponseDiv.textContent = "Xin lỗi, không thể tạo ra câu trả lời cho câu hỏi này. Vui lòng thử lại với một câu hỏi khác.";
                    resultContainer.classList.remove('hidden');
                }

            } catch (error) {
                console.error("AI Search Error:", error);
                errorBox.textContent = `Đã xảy ra lỗi trong quá trình tra cứu AI: ${error.message}. Vui lòng kiểm tra console để biết thêm chi tiết.`;
                errorBox.classList.remove('hidden');
            } finally {
                // Tắt trạng thái loading
                isProcessing = false;
                searchButton.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
